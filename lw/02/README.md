# Traceroute

- Issues: [3](https://github.com/nadevko/bsuir-CSnN-1/issues/3)

Реализация утилиты traceroute на языке F#. Эта утилита позволяет отслеживать маршрут, по которому пакеты данных
передаются от компьютера к заданному узлу в сети.

Особенности:

- Поддержка протоколов ICMP и UDP
- Параллельное выполнение запросов для ускорения трассировки
- Отображение времени задержки для каждого узла
- Разрешение имен хостов (с возможностью отключения)
- Настраиваемые TTL, размер пакетов и другие параметры
- Автоматический выбор протокола передачи

## Использование

```bash
lw02 [options] host [packetsize]
```

### Основные опции

- `-I`, `--icmp`: Использовать протокол ICMP
- `-U`, `--udp`: Использовать протокол UDP (по умолчанию)
- `-4`, `--ipv4`: Использовать IPv4
- `-n`, `--no-resolve`: Не разрешать IP-адреса в имена хостов
- `-f`, `--first <value>`: Начальный TTL (по умолчанию: 1)
- `-m`, `--max <value>`: Максимальное количество переходов (по умолчанию: 30)
- `-p`, `--port <value>`: Порт (по умолчанию: 33434, для случайного: 0)
- `-q`, `--queries <value>`: Количество запросов на каждый узел (по умолчанию: 3)
- `-j`, `--jobs <value>`: Количество параллельных запросов (по умолчанию: 6)
- `-r`, `--receive <value>`: Максимальное время ожидания ответа в секундах (по умолчанию: 0.5)
- `-s`, `--send <value>`: Максимальное время ожидания отправки пакетов в секундах (0.5)
- `-i`, `--interface <value>`: Сетевой интерфейс для отправки пакетов

### Примеры

```bash
# Базовое использование
lw02 1.1.1.1

# Использование ICMP
lw02 -I 1.1.1.1

# Трассировка с 5 запросами на каждый узел
lw02 -q 5 1.1.1.1

# Трассировка с указанием максимального TTL
lw02 -m 15 1.1.1.1

# Трассировка без разрешения имен хостов
lw02 -n 1.1.1.1
```

## Реализация

Трассировка маршрута работает путем отправки пакетов с постепенно увеличивающимся значением TTL (Time To Live). Когда
TTL достигает нуля на маршрутизаторе, тот отправляет обратно сообщение ICMP "Time Exceeded". Это позволяет определить
промежуточные узлы на пути к целевому хосту.

Реализация включает:

- Модуль ICMP для трассировки через ICMP Echo
- Модуль UDP для трассировки через UDP
- Модуль автоматического выбора протокола, переключающийся с UDP на ICMP при необходимости
- Вычисление контрольной суммы для корректной передачи пакетов

## Сборка и запуск

### .NET

Требуется .NET 8.0 SDK или выше.

```bash
git clone https://github.com/nadevko/bsuir-CSnN-1
cd bsuir-CSnN-1/lw/02

# Запуск (права суперпользователя)
dotnet run -- 1.1.1.1
```

### Nix

Требуется установленный Nix с поддержкой flakes (с опцией `--experimental-features 'nix-command flakes'`).

```bash
# Запуск напрямую, без дополнительных команд
nix run github:nadevko/bsuir-CSnN-1#lw02 -- 1.1.1.1

# Добавление в профиль пользователя для системного доступа
nix profile install github:nadevko/bsuir-CSnN-1#lw02

# Теперь доступно как обычная команда в любой директории
lw02 -n -q 2 github.com
```

Для пользователей NixOS предусмотрен специальный модуль, который автоматически интегрирует lw02 в систему и настраивает
необходимые разрешения (capabilities) для работы с raw сокетами без прав суперпользователя:

```nix
# В файле flake.nix вашей конфигурации NixOS
{
  inputs = {
    bsuir-CSnN-1-lw02.url = "github:nadevko/bsuir-CSnN-1?dir=lw/02";
  };

  outputs = { nixpkgs, bsuir-CSnN-1-lw02, ... }: {
    nixosConfigurations.your-hostname = nixpkgs.lib.nixosSystem {
      modules = [
        bsuir-CSnN-1-lw02.nixosModules.default
      ];
    };
  };
}
```

Далее, пересобрать систему:

```bash
nixos-rebuild switch
```

Команда `lw02` будет доступна в системе с необходимыми привилегиями, и её можно использовать как обычную сетевую
утилиту:

```bash
lw02 [options] host [packetsize]
```
